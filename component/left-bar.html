<div class="jpn-left-bar">
    <!-- <div id="left-bar-resizer"></div> -->
</div>


<ul hidden="hidden" id="list-template" class="navi-list">
    <li class="li-item">
        <div class="expand"></div>
        <a class="link">Level 1</a>
        <!-- to add more navi-list here of have children -->
    </li>
</ul>

<script>

    var JpnNavi = function (id, label, url, children = null, isParent = false, code = null, auth = null) {
        this.id = id;
        this.label = label;
        this.url = url;
        this.isParent = isParent;
        this.children = children;
        this.code = code;
        this.auth = auth;
    };

    JpnNavi.prototype.getRealUrl = function () {
        if (this.url !== null && typeof this.url !== "undefined" && this.url != "") {
            return this.url;
        }

        var toRet = SITE_ROOT + "/?page=" + this.id;
        if (this.code !== null && !Number.isNaN(Number.parseInt(this.code))) {
            toRet += "&code=" + this.code;
        }

        return toRet;
    };

    JpnNavi.prototype.renderList = function (template, currentPage) {
        var el = template.clone(true, true);
        el.removeAttr("hidden");
        var expand = el.find(".expand");

        // prepare link
        var link = el.find(".link");
        link.html(this.label);
        link.attr("href", this.getRealUrl());
        if (currentPage == this.id) {
            link.addClass("active");
        }

        if (this.isParent) {
            el.addClass("parent");
        }
        // has children
        if (this.children !== null) {
            var childs = $("<div class='children'></div>");
            for (var i in this.children) {
                var c = this.children[i];
                var c_el = c.renderList(template, currentPage);
                childs.append(c_el);
            }
            el.append(childs);
            childs.attr("hidden", "hidden");
            expand.html(this.getArrow("right"));
        }
        // no children
        else {
            expand.html("<i class='fa fa-dot-circle left sm text-muted'></i>");
            expand.removeClass("expand");
        }

        el.attr("id", this.id);
        return el;
    };

    JpnNavi.prototype.getArrow = function (type) {
        return "<i class='fa fa-chevron-circle-" + type + " left sm'></i>";
    };

    $(document).ready(function () {

        // #######################################
        var parent = $(".jpn-left-bar");
        var resizer = parent.find("#left-bar-resizer");
        var content = $(".jpn-content");

        var template = $("#list-template");
        var JPNNavi = new JpnNavi();
        var currentPage = Util._GET("page");

        function renderNavis(navis, template) {
            for (var i in navis) {
                var n = navis[i];
                var el = n.renderList(template, currentPage);
                parent.append(el);
            }
        }

        function addEventListener() {
            var expands = parent.find(".expand");
            expands.click(function () {
                var e = $(this);
                var par = e.parent().parent();
                var child = $(par.find(".children")[0]);

                if (typeof child.attr("hidden") === "undefined") {
                    child.attr("hidden", "hidden");
                    e.html(JPNNavi.getArrow("right"));
                } else {
                    child.removeAttr("hidden");
                    e.html(JPNNavi.getArrow("down"));
                }
            });

            if (currentPage !== Util.PAGE_DEFAULT) {


                try {
                    var curEl = parent.find("#" + currentPage);
                } catch (err) {
                    console.log(err);
                    curEl = [];
                }

                if (curEl.length > 0) {
                    expandCurrentPage(curEl);
                }
            }
        }

        function expandCurrentPage(curEl) {
            // expand base on currentPage
            var siblings = curEl.parent();
            if (!siblings.hasClass("jpn-left-bar")) {
                siblings.removeAttr("hidden");
                var parentUl = siblings.parent();
                var parentLiExpand = parentUl.find(".li-item .expand");
                $(parentLiExpand[0]).html(JPNNavi.getArrow("down"));
                expandCurrentPage(parentUl)
            }
        }

        function createJpnNavi(d) {
            var children = null;
            if (d.children !== null && Array.isArray(d.children)) {
                children = d.children.map((_d, _i) => {
                    return createJpnNavi(_d);
                })
            }
            return new JpnNavi(d.id, d.label, d.url, children, d.isParent);
        }

        function getData(url, success) {
            // #########################################
            // prepare data
            var ERR_MES = "Failed to get navigation list.<br>";
            $.ajax({
                dataType: "json",
                url: url,
                data: {},
                success: function (data) {
                    try {
                        console.log(data);
                        //data = JSON.parse(data);
                        navis = data.map((d, i) => {
                            return createJpnNavi(d);
                        });
                        success(navis);
                        return navis;

                    } catch (err) {
                        parent.html(ERR_MES + err);
                        return false;
                    }
                }
            });
        }


        function registerResizer() {

            function doResizing(leftWidth) {
                if (content.length <= 0) {
                    content = $(".jpn-content");
                }

                parent.css("width", "" + leftWidth + "px");
                content.css("padding-left", "" + leftWidth + "px");
                resizer.css("left", "" + leftWidth + "px");
            }

            resizer.mousedown(function (ev) {
                intervalSizing = setInterval(function () {
                    console.log(window.event.clientX);
                }, 100);

                // var cur = resizer.css("left");
                // cur = Number.parseInt(cur.replace("px", ""));
                // console.log(cur);

                //doResizing(ev.pageX);

            });

            var intervalSizing = null;
            resizer.mouseup(function (ev) {
                if (intervalSizing !== null) {
                    clearInterval(intervalSizing);
                }
            });

        }

        function Main() {
            registerResizer();
            var path = SITE_ROOT + "/dataset/navi-utama.json?v=" + NAVI_VER;
            getData(path, function (navis) {
                renderNavis(navis, template);
                addEventListener();
            });
        }


        Main();
    });



            /*
            n = new JpnNavi("Level 3", "", [
                new JpnNavi("Level 3 - Child 1", ""),
                new JpnNavi("Level 3 - Child 2", "", [
                    new JpnNavi("Level 3 - Child 2 Child 1", "", [
                        new JpnNavi("Level 3 - GrandChildren 2 Child 1", ""),
                        new JpnNavi("Level 3 - GrandChildren 2 Child 1", "")
                    ]),
                    new JpnNavi("Level 3 - Child 2 Child 2", "")
                ]),
                new JpnNavi("Level 3 - Child 3", "")
            ], true);
            navis.push(n);
            */


</script>